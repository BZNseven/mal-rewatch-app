<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MAL Rewatch Curator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --text: #e6e6ea;
      --muted: #a0a4ac;
      --accent: #4aa3ff;
      --good: #3ecf8e;
      --warn: #f59e0b;
      --border: #262a35;
      --chip: #222735;
      --highlight: rgba(74,163,255,0.12);
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    a { color: var(--accent); text-decoration: none; } a:hover{ text-decoration: underline; }
    .wrap { max-width: 1200px; margin: 24px auto 80px; padding: 0 16px; }
    header { display:flex; align-items:center; gap:12px; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; }
    .btn { background: var(--panel); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.primary { background: linear-gradient(180deg, #2b6cdf, #1f5bd1); border-color:#1b4fb6; }
    .btn.ghost { background: transparent; border-color: var(--border); }
    .btn.warn { background:#2a1c0b; border-color:#3b2b11; color:#fbbf24; }
    .controls { display:flex; flex-wrap: wrap; gap:8px; align-items:center; }
    .field { display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--border); padding:6px 10px; border-radius:8px; }
    .field input[type="text"], .field input[type="number"], .field select { background: transparent; border:none; outline:none; color:var(--text); }
    .muted { color: var(--muted); }
    .chips { display:flex; gap:6px; flex-wrap: wrap; }
    .chip { background: var(--chip); padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
    hr.sep { border:none; border-top:1px solid var(--border); margin:16px 0; }
    .progress { background:#141822; border:1px solid var(--border); border-radius:10px; overflow:hidden; height:14px; position:relative; }
    .bar { background: linear-gradient(90deg, var(--accent), var(--good)); width:0%; height:100%; transition: width .2s; }
    .progress-row { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid var(--border); vertical-align: top; }
    thead th { text-align:left; font-weight:600; color:#cfd3dc; position: sticky; top: 0; background: var(--bg); }
    tbody tr:hover { background: #141821; }
    tr.highlight { background: var(--highlight); }
    .grid { display:grid; gap:12px; }
    @media(min-width:900px){ .grid.cols-2 { grid-template-columns: 1fr 1fr; } }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .card h3 { margin:0 0 8px; font-size:16px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .note { font-size:12px; color:var(--muted); }
    .recs { display:grid; gap:8px; }
    .rec { background:#121723; border:1px solid var(--border); border-radius:10px; padding:10px; position:relative; }
    .rec h4 { margin:0 0 4px; font-size:15px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#1a1f2b; color:#bfc5d3; }
    .right { text-align:right; }
    .small { font-size:12px; }
    .authed-only { display:none; }
    .error { color:#ff6b6b; }
    /* E) Min Score menu readability */
    select#minScore option { color:#111; background:#fff; }
    /* F) Dismiss button */
    .rec .rec-close {
      position:absolute; top:6px; right:8px; width:22px; height:22px; border-radius:50%;
      border:1px solid var(--border); background:transparent; color:#bfc5d3; cursor:pointer; line-height:20px; text-align:center;
    }
    .rec .rec-close:hover { color:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="controls">
        <button id="loginBtn" class="btn">Sign in with MAL</button>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
      <div class="controls">
        <div class="field"><label><input type="checkbox" id="completedOnly"> Completed only</label></div>
        <div class="field"><span class="muted">Tag:</span><input id="tagInput" type="text" value="Rewatch" size="10" /></div>
        <button id="loadBtn" class="btn primary">Load List</button>
        <button id="csvBtn" class="btn authed-only">Download CSV</button>
        <button id="mdBtn" class="btn authed-only">Download Markdown</button>
        <button id="copyMdBtn" class="btn authed-only">Copy Markdown</button>
        <button id="clearCacheBtn" class="btn warn authed-only" title="Clear cached detail lookups">Clear details cache</button>
      </div>
    </header>

    <div class="grid cols-2">
      <div class="card">
        <h3>Progress</h3>
        <div class="progress-row">
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div id="progressText" class="muted small right">0%</div>
        </div>
        <div class="row small muted" id="countsRow" style="margin-top:8px;">Waiting…</div>
      </div>

      <div class="card">
        <h3>Quick Filters</h3>
        <div class="row">
          <div class="field" title="Filter titles live"><span>Search</span><input id="searchBox" type="text" placeholder="Type to filter titles…" size="24"></div>
          <div class="field" title="Hide rows below a score"><span>Min Score</span>
            <select id="minScore">
              <option value="">Any</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            </select>
          </div>
        </div>
        <div class="note small">Search and min score are client-side filters and won’t re-fetch data.</div>
      </div>
    </div>

    <hr class="sep" />

    <section class="grid cols-2">
      <div class="card">
        <h3>Profile Snapshot</h3>
        <div class="note small">Favorites set from your Rewatch list, weighted by your scores.</div>
        <div class="stack" style="margin-top:8px;">
          <div>
            <div class="row">
              <strong>Top Genres</strong>
              <label class="field"><input type="checkbox" id="genreBiasOn"> Bias</label>
              <div class="field"><span>weight</span><input type="number" id="genreBiasW" min="0" step="0.1" max="3" value="0.8"></div>
            </div>
            <div id="topGenres" class="chips"></div>
          </div>
          <div>
            <div class="row">
              <strong>Top Studios</strong>
              <label class="field"><input type="checkbox" id="studioBiasOn"> Bias</label>
              <div class="field"><span>weight</span><input type="number" id="studioBiasW" min="0" step="0.1" max="3" value="0.8"></div>
            </div>
            <div id="topStudios" class="chips"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Recommendations</h3>
        <div class="row">
          <button id="genRecsBtn" class="btn primary authed-only">Generate recommendations</button>
          <span class="note small">12 picks, max 1 per franchise. PTW/On-Hold are allowed and labeled.</span>
        </div>
        <div id="recs" class="recs" style="margin-top:10px;"></div>
      </div>
    </section>

    <hr class="sep" />

    <section class="card">
      <h3>Rewatch List</h3>
      <div class="note small">Matches tag <strong>Rewatch</strong> exactly after splitting comma tags. English title preferred. Score 0 shows as “—”.</div>
      <div style="overflow:auto; margin-top:8px;">
        <table id="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>My Score</th>
              <th>Genres</th>
              <th>Year</th>
              <th>Type</th>
              <th>Ep</th>
              <th>Studios</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <p class="note small" style="margin-top:12px;">
      Settings save locally for 90 days. NSFW visibility is on via the proxy.
    </p>
  </div>

<script>
/* ---------- Helpers ---------- */
function $(s){ return document.querySelector(s); }
function $$(s){ return Array.from(document.querySelectorAll(s)); }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function MAL_LINK(id){ return 'https://myanimelist.net/anime/' + id; }

function getCookie(name){
  var m = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
  return m ? decodeURIComponent(m[2]) : null;
}
function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadLS(k, d){ try{ var v = localStorage.getItem(k); return v ? JSON.parse(v) : (d===undefined?null:d); }catch(e){ return d===undefined?null:d; } }

function setProgress(done, total, label){
  var pct = total ? Math.floor(done/total*100) : 0;
  $('#bar').style.width = pct + '%';
  $('#progressText').textContent = pct + '%';
  if(label) $('#countsRow').textContent = label;
}

/* ---------- API via Netlify proxy ---------- */
var API = {
  animelist: async function(params){
    var qs = new URLSearchParams(params);
    var res = await fetch('/api/animelist?' + qs.toString(), { credentials:'include' });
    if(!res.ok) throw new Error('animelist ' + res.status);
    return res.json();
  },
  animeDetails: async function(id, fields){
    var qs = new URLSearchParams({ fields: fields });
    var res = await fetch('/api/anime/' + id + '?' + qs.toString(), { credentials:'include' });
    if(!res.ok) throw new Error('anime ' + id + ' ' + res.status);
    return res.json();
  },
  animeRanking: async function(ranking_type, limit, offset, fields){
    var qs = new URLSearchParams({
      ranking_type: ranking_type || 'bypopularity',
      limit: String(limit || 100),
      offset: String(offset || 0),
      fields: fields || 'id,title,alternative_titles,mean,genres,studios,start_season,media_type'
    });
    var res = await fetch('/api/anime-ranking?' + qs.toString(), { credentials:'include' });
    if(!res.ok) throw new Error('ranking ' + ranking_type + ' ' + res.status);
    return res.json();
  }
};

/* ---------- State & cache ---------- */
var allList = [];
var rewatchRows = [];
var topGenres = [];
var topStudios = [];
var excludeIdSet = new Set();

// B) For PTW/On-Hold badges and selective exclude
var ptwIdSet = new Set();
var onHoldIdSet = new Set();

// G) Per-session rotation + seen
var seenRecIds = new Set();
var recsSeed = Number(sessionStorage.getItem('recsSeed') || '0') | 0;
(function initSeen(){ try{ JSON.parse(sessionStorage.getItem('seenRecIds') || '[]').forEach(function(id){ seenRecIds.add(id); }); }catch(e){} })();
function saveSeen(){ sessionStorage.setItem('seenRecIds', JSON.stringify(Array.from(seenRecIds).slice(-500))); }
function bumpRecsSeed(){ recsSeed = (recsSeed + 1) % 6; sessionStorage.setItem('recsSeed', String(recsSeed)); }

// F) Dismissed recs persist
function getSkipRecs(){ try { return new Set(JSON.parse(localStorage.getItem('skipRecs') || '[]')); } catch(e){ return new Set(); } }
function addSkipRec(id){ var s = getSkipRecs(); s.add(id); localStorage.setItem('skipRecs', JSON.stringify(Array.from(s))); }

var CACHE_TTL_MS = 90*24*60*60*1000;
function cacheGet(key){
  var raw = loadLS('cache:'+key, null);
  if(!raw) return null;
  if(Date.now() - raw.t > CACHE_TTL_MS) return null;
  return raw.v;
}
function cacheSet(key, val){
  saveLS('cache:'+key, { t: Date.now(), v: val });
}

/* ---------- Auth UI ---------- */
function reflectAuth(){
  var has = !!getCookie('mal_access'); // cookie is HttpOnly, so this may be false even when logged in
  $$('.authed-only').forEach(function(el){ el.style.display = has ? '' : 'none'; });
}
$('#loginBtn').onclick = function(){ window.location.href = '/.netlify/functions/auth-start'; };
$('#logoutBtn').onclick = function(){ document.cookie='mal_access=; Max-Age=0; path=/'; document.cookie='mal_refresh=; Max-Age=0; path=/'; location.reload(); };
reflectAuth();

/* ---------- Table + snapshot ---------- */
function parseEnglishTitle(node){
  var en = node.alternative_titles && node.alternative_titles.en;
  return en && en.trim().length ? en : node.title;
}
function commaTagsInclude(tags, needle){
  if (!tags || !needle) return false;
  var want = String(needle).trim().toLowerCase();
  if (Array.isArray(tags)) return tags.some(function(t){ return String(t).trim().toLowerCase() === want; });
  return String(tags).split(',').map(function(s){ return s.trim().toLowerCase(); }).filter(Boolean).some(function(p){ return p === want; });
}
function fmtScore(s){ return s && s > 0 ? String(s) : '—'; }
function chip(text){ var c = document.createElement('span'); c.className='chip'; c.textContent = text; return c; }

function renderTable(){
  var q = ($('#searchBox').value || '').toLowerCase();
  var min = parseInt($('#minScore').value || '0', 10);
  var tbody = $('#tbody'); tbody.innerHTML = '';
  var shown = 0;

  var topGset = new Set(topGenres.map(function(g){ return g.name; }));
  var topSset = new Set(topStudios.map(function(s){ return s.name; }));

  rewatchRows.forEach(function(r){
    if(q && r.title.toLowerCase().indexOf(q) === -1) return;
    if(min && (r.myScore || 0) < min) return;

    var tr = document.createElement('tr');
    var hasSig = r.genres.some(function(g){ return topGset.has(g); }) || r.studios.some(function(s){ return topSset.has(s); });
    if(hasSig) tr.classList.add('highlight');

    tr.innerHTML =
      '<td>'+r.title+'</td>'+
      '<td>'+fmtScore(r.myScore)+'</td>'+
      '<td>'+r.genres.slice(0,3).join(', ')+'</td>'+
      '<td>'+(r.year||'')+'</td>'+
      '<td>'+(r.type||'')+'</td>'+
      '<td>'+(r.episodes||'')+'</td>'+
      '<td>'+r.studios.slice(0,2).join(', ')+'</td>'+
      '<td><a href="'+MAL_LINK(r.id)+'" target="_blank" rel="noopener">MAL</a></td>';

    tbody.appendChild(tr); shown++;
  });

  var cs = loadLS('cacheStats', {hits:0,miss:0});
  $('#countsRow').textContent = 'Rows: '+shown+'/'+rewatchRows.length+'. Cached details: '+cs.hits+' hits, '+cs.miss+' misses.';
}

function updateSnapshot(){
  var gCounts = new Map();
  var sCounts = new Map();
  rewatchRows.forEach(function(r){
    var w = r.myScore && r.myScore > 0 ? r.myScore : 0;
    if(w === 0) return;
    r.genres.forEach(function(g){ gCounts.set(g, (gCounts.get(g)||0) + w); });
    r.studios.forEach(function(s){ sCounts.set(s, (sCounts.get(s)||0) + w); });
  });
  function toArr(m){
    return Array.from(m.entries()).map(function(e){ return {name:e[0], weight:Math.round(e[1])}; }).sort(function(a,b){ return b.weight - a.weight; }).slice(0,12);
  }
  topGenres = toArr(gCounts);
  topStudios = toArr(sCounts);

  var tg = $('#topGenres'); tg.innerHTML = '';
  topGenres.forEach(function(g){ tg.appendChild(chip(g.name+' · '+g.weight)); });
  var ts = $('#topStudios'); ts.innerHTML = '';
  topStudios.forEach(function(s){ ts.appendChild(chip(s.name+' · '+s.weight)); });

  // persist bias UI
  var gbOn = $('#genreBiasOn').checked, sbOn = $('#studioBiasOn').checked;
  var gbW = parseFloat($('#genreBiasW').value||'0'), sbW = parseFloat($('#studioBiasW').value||'0');
  saveLS('bias', { gbOn:gbOn, sbOn:sbOn, gbW:gbW, sbW:sbW });
}

/* ---------- Load + Enrich ---------- */
async function loadAllMyListIds(){
  var out = new Set(); // exclude: watching/completed/dropped
  ptwIdSet = new Set();
  onHoldIdSet = new Set();

  var next = 0;
  while(true){
    var data = await API.animelist({ limit: 100, offset: next, fields: 'list_status{status}' });
    (data.data||[]).forEach(function(it){
      var stObj = it.list_status || (it.node && (it.node.my_list_status || it.node.list_status)) || {};
      var st = stObj.status || ''; var id = it.node.id;
      if(st === 'plan_to_watch'){ ptwIdSet.add(id); return; }
      if(st === 'on_hold'){ onHoldIdSet.add(id); return; }
      if(st === 'watching' || st === 'completed' || st === 'dropped'){ out.add(id); return; }
      if(!st) out.add(id); // unknown -> conservative exclude
    });
    if(!data.paging || !data.paging.next) break;
    var u = new URL(data.paging.next);
    next = parseInt(u.searchParams.get('offset')||'0',10);
    await sleep(120);
  }
  excludeIdSet = out;
}

async function handleLoad(){
  setProgress(0,1,'Fetching your list…');
  try {
    var items = [], next = 0;
    while(true){
      var data = await API.animelist({ limit: 100, offset: next, fields: 'list_status{status,score,tags}' });
      items = items.concat(data.data||[]);
      if(!data.paging || !data.paging.next) break;
      var u = new URL(data.paging.next);
      next = parseInt(u.searchParams.get('offset')||'0',10);
    }
    allList = items;

    // D) show authed controls now that a call succeeded
    $$('.authed-only').forEach(function(el){ el.style.display = ''; });

    // filter
    var tag = ($('#tagInput').value||'Rewatch').trim();
    var completedOnly = $('#completedOnly').checked;
    var filtered = items.filter(function(it){
      var ls = it.list_status || (it.node && (it.node.my_list_status || it.node.list_status)) || {};
      var tags = ls && (ls.tags || '');
      var hasTag = commaTagsInclude(tags, tag);
      var statusOk = !completedOnly || (ls && ls.status === 'completed');
      return hasTag && statusOk;
    });

    var total = filtered.length;
    setProgress(0,total,'Found '+total+' Rewatch entries. Enriching…');

    // Enrich
    var cacheStats = loadLS('cacheStats', {hits:0,miss:0});
    var out = [], fields='alternative_titles,genres,studios,start_season,num_episodes,media_type';
    var queue = filtered.slice(); var done = 0; var concurrency = 6;

    async function worker(){
      while(queue.length){
        var it = queue.shift(); var id = it.node.id;
        var det = cacheGet('anime:'+id); if(det){ cacheStats.hits++; }
        if(!det){
          var attempts=0;
          while(true){
            try { det = await API.animeDetails(id, fields); cacheSet('anime:'+id, det); cacheStats.miss++; break; }
            catch(err){ attempts++; if(attempts>=3) throw err; await sleep(500*attempts); }
          }
        }
        var ls = it.list_status || (it.node && (it.node.my_list_status || it.node.list_status)) || {};
        var title = parseEnglishTitle(det);
        var genres = (det.genres||[]).map(function(g){ return g.name; });
        var studios = (det.studios||[]).map(function(s){ return s.name; });
        var start = det.start_season && det.start_season.year;

        out.push({ id:id, title:title, genres:genres, studios:studios, year:start||'', type:det.media_type||'', episodes:det.num_episodes||'', myScore: ls.score || 0 });
        done++; setProgress(done,total,'Enriched '+done+'/'+total);
      }
    }
    var nWorkers = Math.min(concurrency, queue.length);
    await Promise.all(Array.from({length:nWorkers}).map(function(){ return worker(); }));
    saveLS('cacheStats', cacheStats);

    rewatchRows = out.sort(function(a,b){ return a.title.localeCompare(b.title); });
    updateSnapshot();
    renderTable();
  } catch (err){
    $('#countsRow').innerHTML = '<span class="error">Error: '+err.message+'</span>';
  }
}

/* ---------- Exports ---------- */
function toCSV(rows){
  var head = ['Title','My Score','Genres','Year','Type','Ep','Studios','Link'], lines = [head.join(',')];
  rows.forEach(function(r){
    var cols = [
      '"' + r.title.replace(/"/g,'""') + '"',
      fmtScore(r.myScore),
      '"' + r.genres.slice(0,3).join(' / ').replace(/"/g,'""') + '"',
      r.year||'',
      r.type||'',
      r.episodes||'',
      '"' + r.studios.slice(0,2).join(' / ').replace(/"/g,'""') + '"',
      MAL_LINK(r.id)
    ];
    lines.push(cols.join(','));
  });
  return lines.join('\n');
}
function toMarkdown(rows){
  var head='| Title | My Score | Genres | Year | Type | Ep | Studios |\n|---|---:|---|---:|---|---:|---|\n';
  var body=rows.map(function(r){ return '| ['+r.title+']('+MAL_LINK(r.id)+') | '+fmtScore(r.myScore)+' | '+r.genres.slice(0,3).join(' / ')+' | '+(r.year||'')+' | '+(r.type||'')+' | '+(r.episodes||'')+' | '+r.studios.slice(0,2).join(' / ')+' |'; }).join('\n');
  return head+body+'\n';
}
function download(name, text, type){
  var blob = new Blob([text], {type: type || 'text/plain'}); var url = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Recommender (A, B, C, F, G) ---------- */
function getBias(){
  var b = loadLS('bias', {}) || {};
  b.gbOn = $('#genreBiasOn').checked; b.sbOn = $('#studioBiasOn').checked;
  b.gbW = parseFloat($('#genreBiasW').value||'0'); b.sbW = parseFloat($('#studioBiasW').value||'0');
  saveLS('bias', b); return b;
}
function franchiseKey(title){
  var t = String(title).toLowerCase();
  t = t.replace(/[\u00B0'’´`]/g,'');     // normalize degree/quotes
  t = t.replace(/[:(].*$/,'');           // cut after ":" or "("
  t = t.replace(/[^a-z0-9]+/g,' ').trim();
  return t;
}

// F) Dismiss handler
$('#recs').addEventListener('click', function(e){
  var btn = e.target.closest('.rec-close'); if(!btn) return;
  var id = Number(btn.getAttribute('data-id')); addSkipRec(id); seenRecIds.add(id); saveSeen();
  var card = btn.closest('.rec'); if(card) card.remove();
});

async function generateRecs(){
  if(!rewatchRows.length){ alert('Load your Rewatch list first.'); return; }
  $('#recs').innerHTML = '<div class="note small">Finding candidates…</div>';

  try{
    await loadAllMyListIds(); // refresh exclude + PTW/On-Hold sets
    var gTopSet = new Set(topGenres.map(function(x){ return x.name; }));
    var sTopArr = topStudios.slice(0,3).map(function(x){ return x.name; });
    var sTopSet = new Set(sTopArr);
    var bias = getBias();
    var skip = getSkipRecs();

    // G) rotate offsets to vary results per click
    var offA = (recsSeed % 3) * 100;
    var offB = ((recsSeed + 1) % 3) * 100;
    var fields = 'id,title,alternative_titles,mean,genres,studios,start_season,media_type';

    var results = await Promise.all([
      API.animeRanking('bypopularity', 100, offA, fields),
      API.animeRanking('bypopularity', 100, offB, fields),
      API.animeRanking('all',          100, offA, fields),
      API.animeRanking('all',          100, offB, fields)
    ]);

    // Merge unique candidates
    var uniq = new Map();
    results.forEach(function(src){
      (src.data||[]).forEach(function(item){
        var n = item.node || item;
        uniq.set(n.id, n);
      });
    });

    // Score + filter
    var scored = [];
    uniq.forEach(function(n){
      var id = n.id;
      if(skip.has(id)) return;                 // user dismissed
      if(seenRecIds.has(id)) return;           // shown this session
      if(excludeIdSet.has(id)) return;         // watching/completed/dropped (B)

      var title = parseEnglishTitle(n);
      var genres = (n.genres||[]).map(function(g){ return g.name; });
      var studios = (n.studios||[]).map(function(s){ return s.name; });

      var gOverlap=0,i; for(i=0;i<genres.length;i++) if(gTopSet.has(genres[i])) gOverlap++;
      var sOverlap=0,j; for(j=0;j<studios.length;j++) if(sTopSet.has(studios[j])) sOverlap++;
      if(gOverlap===0 && sOverlap===0) return; // keep v1 tight

      var base = 1 + gOverlap + sOverlap;
      var mean = typeof n.mean === 'number' ? n.mean : 0;
      base += mean * 0.02;

      var mult = 1;
      if(bias.sbOn) mult *= (1 + (bias.sbW||0) * sOverlap);
      if(bias.gbOn) mult *= (1 + (bias.gbW||0) * gOverlap);

      scored.push({ id:id, title:title, genres:genres, studios:studios, mean:mean, score: base*mult, key:franchiseKey(title) });
    });

    // Sort by score
    scored.sort(function(a,b){ return b.score - a.score; });

    // A) 1 per franchise
    var bestByKey = new Map();
    for(var k=0;k<scored.length;k++){ var r=scored[k]; if(!bestByKey.has(r.key)) bestByKey.set(r.key, r); }
    var deduped = Array.from(bestByKey.values());

    // C) diversity: cap max 2 per studio and try to seed picks with top-3 studios
    var studioCounts = new Map();
    function hasTopStudio(r){ for(var i=0;i<r.studios.length;i++) if(sTopSet.has(r.studios[i])) return true; return false; }
    function canTake(r){
      for(var i=0;i<r.studios.length;i++){ var s=r.studios[i]; if((studioCounts.get(s)||0) >= 2) return false; }
      return true;
    }
    function take(r, arr){ arr.push(r); r.studios.forEach(function(s){ studioCounts.set(s, (studioCounts.get(s)||0)+1); }); }

    var picks = [];
    var favs = deduped.filter(hasTopStudio);
    for(var f=0; f<favs.length && picks.length<3; f++){ if(canTake(favs[f])) take(favs[f], picks); }
    for(var m=0; m<deduped.length && picks.length<12; m++){ var r2=deduped[m]; if(picks.some(function(p){ return p.id===r2.id; })) continue; if(!canTake(r2)) continue; take(r2, picks); }

    // B) PTW/On-Hold badges
    function badgeHTML(id){
      if(ptwIdSet.has(id)) return ' <span class="pill">on your plan to watch</span>';
      if(onHoldIdSet.has(id)) return ' <span class="pill">on hold</span>';
      return '';
    }

    // Render
    var recsEl = $('#recs'); recsEl.innerHTML = '';
    picks.forEach(function(r){
      var gHits = (r.genres||[]).filter(function(g){ return gTopSet.has(g); }).slice(0,3);
      var sHits = (r.studios||[]).filter(function(s){ return sTopSet.has(s); }).slice(0,2);
      var parts = [];
      if(gHits.length) parts.push('shares top genres: '+gHits.join(', '));
      if(sHits.length) parts.push('from favorite studio'+(sHits.length>1?'s':'')+': '+sHits.join(', '));
      if(!parts.length) parts.push('tonal neighbor to your favorites');

      var div = document.createElement('div'); div.className='rec';
      div.innerHTML =
        '<button class="rec-close" title="Hide this" data-id="'+r.id+'">×</button>'+
        '<h4><a href="'+MAL_LINK(r.id)+'" target="_blank" rel="noopener">'+r.title+'</a></h4>'+
        '<div class="small muted">'+parts.join(' · ')+(r.mean?(' · MAL mean '+r.mean.toFixed(1)):'')+badgeHTML(r.id)+'</div>'+
        '<div class="chips" style="margin-top:6px;">'+
          r.genres.slice(0,3).map(function(g){ return '<span class="pill">'+g+'</span>'; }).join(' ')+
          r.studios.slice(0,2).map(function(s){ return ' <span class="pill">'+s+'</span>'; }).join('')+
        '</div>';
      recsEl.appendChild(div);
    });

    // Remember + advance seed
    picks.forEach(function(p){ seenRecIds.add(p.id); });
    saveSeen(); bumpRecsSeed();

    if(picks.length===0) $('#recs').innerHTML = '<div class="small muted">No matches found from the current pools. Click again for a fresh mix.</div>';
  }catch(err){
    $('#recs').innerHTML = '<div class="small error">Failed to generate recommendations: '+err.message+'</div>';
  }
}

/* ---------- Wire UI ---------- */
$('#loadBtn').onclick = handleLoad;
$('#csvBtn').onclick = function(){ download('rewatch.csv', toCSV(rewatchRows), 'text/csv'); };
$('#mdBtn').onclick = function(){ download('rewatch.md', toMarkdown(rewatchRows), 'text/markdown'); };
$('#copyMdBtn').onclick = async function(){ await navigator.clipboard.writeText(toMarkdown(rewatchRows)); alert('Markdown copied.'); };
$('#clearCacheBtn').onclick = function(){
  Object.keys(localStorage).forEach(function(k){ if(k.indexOf('cache:anime:')===0 || k==='cacheStats') localStorage.removeItem(k); });
  alert('Cleared cached details.');
};
$('#searchBox').addEventListener('input', renderTable);
$('#minScore').addEventListener('change', renderTable);
$('#genreBiasOn').addEventListener('change', function(){ saveLS('bias', getBias()); renderTable(); });
$('#studioBiasOn').addEventListener('change', function(){ saveLS('bias', getBias()); renderTable(); });
$('#genreBiasW').addEventListener('change', function(){ saveLS('bias', getBias()); });
$('#studioBiasW').addEventListener('change', function(){ saveLS('bias', getBias()); });
$('#genRecsBtn').onclick = generateRecs;

// restore saved bias toggles
(function(){
  var savedBias = loadLS('bias', null);
  if(savedBias){
    $('#genreBiasOn').checked = !!savedBias.gbOn;
    $('#studioBiasOn').checked = !!savedBias.sbOn;
    if(typeof savedBias.gbW === 'number') $('#genreBiasW').value = savedBias.gbW;
    if(typeof savedBias.sbW === 'number') $('#studioBiasW').value = savedBias.sbW;
  }
})();
</script>
</body>
</html>
